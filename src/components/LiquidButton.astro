---
interface Props {
  class?: string;
  w: number;
  h: number;
  morph?: true;
  color?: 'black' | 'white' | 'transparent'
}

const { class: className, w, h, morph, color = 'transparent' } = Astro.props;

const width = w;
const height = h;
const scale = h / 126;
const edgeWidth = Math.round(63 * scale);
const rightX = width - edgeWidth;
const middleWidth = Math.max(0, width - edgeWidth * 2);
const middleMask = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='${width}' height='${height}'%3E%3Crect x='${edgeWidth}' y='0' width='${middleWidth}' height='${height}' fill='white'/%3E%3C/svg%3E`;
const backdropBG = (() => {
    switch (color) {
        case 'transparent': return ''
        case 'black': return ' brightness(0.4)'
        case 'white': return ' saturate(1.2) contrast(0.4) brightness(1.6)'
    }
})()
---

<div class:list={["liquid-glass-button relative", className]} style={`width: ${width}px; height: ${height}px;`}>
  {morph != null ? (
    <div class="absolute inset-0 rounded-full" style="backdrop-filter: blur(16px) saturate(110%) brightness(1.1); -webkit-backdrop-filter: blur(16px) saturate(110%) brightness(1.1); background: rgba(255, 255, 255, 0.1);"></div>
  ) : (
    <>
    <svg 
        class="absolute pointer-events-none" 
        color-interpolation-filters="sRGB" 
        width={width}
        height={height}
        style="display: none;"
    >
        <defs>
        <filter id="glass-filter" filterUnits="userSpaceOnUse" x="0" y="0" width={width} height={height}>
            <feGaussianBlur in="SourceGraphic" stdDeviation={0} result="blurred"/>
            <feImage href="/assets/displacement-map-left.png" x="0" y="0" width={edgeWidth} height={height} preserveAspectRatio="none" result="disp_left"/>
            <feImage href="/assets/displacement-map-middle.png" x="0" y="0" width="1" height={height} preserveAspectRatio="none" result="disp_mid_src"/>
            <feTile in="disp_mid_src" result="disp_mid_tiled"/>
            <feImage href={middleMask} x="0" y="0" width={width} height={height} result="mid_mask"/>
            <feComposite in="disp_mid_tiled" in2="mid_mask" operator="in" result="disp_mid"/>
            <feImage href="/assets/displacement-map-right.png" x={rightX} y="0" width={edgeWidth} height={height} preserveAspectRatio="none" result="disp_right"/>
            <feMerge result="displacement">
            <feMergeNode in="disp_left"/>
            <feMergeNode in="disp_mid"/>
            <feMergeNode in="disp_right"/>
            </feMerge>
            <feDisplacementMap in="blurred" in2="displacement" scale={75 * scale} xChannelSelector="R" yChannelSelector="G" result="displaced"/>
            <feColorMatrix in="displaced" type="saturate" values="0" result="displaced_gray"/>
            <feImage href="/assets/specular-map-left.png" x="0" y="0" width={edgeWidth} height={height} preserveAspectRatio="none" result="spec_left"/>
            <feImage href="/assets/specular-map-middle.png" x="0" y="0" width="1" height={height} preserveAspectRatio="none" result="spec_mid_src"/>
            <feTile in="spec_mid_src" result="spec_mid_tiled"/>
            <feComposite in="spec_mid_tiled" in2="mid_mask" operator="in" result="spec_mid"/>
            <feImage href="/assets/specular-map-right.png" x={rightX} y="0" width={edgeWidth} height={height} preserveAspectRatio="none" result="spec_right"/>
            <feMerge result="specular">
            <feMergeNode in="spec_left"/>
            <feMergeNode in="spec_mid"/>
            <feMergeNode in="spec_right"/>
            </feMerge>
            <feComposite in="displaced_gray" in2="specular" operator="in" result="spec_saturated"/>
            <feComponentTransfer in="specular" result="spec_faded">
            <feFuncA type="linear" slope="1"/>
            </feComponentTransfer>
            <feBlend in="spec_saturated" in2="displaced" mode="normal" result="with_saturation"/>
            <feBlend in="spec_faded" in2="with_saturation" mode="normal"/>
        </filter>
        </defs>
    </svg>
    <div class="absolute inset-0 rounded-full" style={`backdrop-filter: url("#glass-filter") blur(1.5px)${backdropBG};`}></div>
    </>
  )}
  <svg 
    class="absolute inset-0 pointer-events-none rounded-full overflow-hidden"
    width={width}
    height={height}
    viewBox={`0 0 ${width} ${height}`}
    preserveAspectRatio="none"
  >
    <defs>
      <clipPath id="pill-clip">
        <rect x="0" y="0" width={width} height={height} rx={height / 2} ry={height / 2}/>
      </clipPath>
      <pattern id="spec-middle-pattern" x={edgeWidth} y="0" width="1" height={height} patternUnits="userSpaceOnUse">
        <image 
          href="/assets/specular-map-middle.png" 
          x="0" 
          y="0" 
          width="1" 
          height={height}
          preserveAspectRatio="none"
        />
      </pattern>
    </defs>
    <g clip-path="url(#pill-clip)">
      <rect 
        x={edgeWidth} 
        y="0" 
        width={middleWidth} 
        height={height} 
        fill="url(#spec-middle-pattern)"
      />
      <image 
        href="/assets/specular-map-left.png" 
        x="0" 
        y="0" 
        width={edgeWidth} 
        height={height}
        preserveAspectRatio="none"
      />
      <image 
        href="/assets/specular-map-right.png" 
        x={rightX} 
        y="0" 
        width={edgeWidth} 
        height={height}
        preserveAspectRatio="none"
      />
    </g>
  </svg>
  <div 
    class="liquid-button-content relative pointer-events-auto flex items-center justify-center" 
    style={`padding-inline: ${height / 2}px; height: ${height}px; line-height: ${height}px;`}
  >
    <slot />
  </div>
</div>
<style>
  .liquid-glass-button {
    display: inline-flex;
    align-items: center;
  }
  
  .liquid-button-content :global(a),
  .liquid-button-content :global(button),
  .liquid-button-content :global(span) {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }
</style>
